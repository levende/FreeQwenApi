# API-прокси для Qwen AI

Локальный API-прокси сервер для работы с Qwen AI через браузерную эмуляцию.

Загрузку файлов на 10 звёзд добавлю - в процессе

## Оглавление

- [Назначение](#назначение)
- [Установка](#установка)
- [Запуск](#запуск)
- [API Reference](#api-reference)
  - [Основные эндпоинты](#основные-эндпоинты)
  - [Форматы запросов](#форматы-запросов)
  - [Работа с изображениями](#работа-с-изображениями)
  - [Управление диалогами](#управление-диалогами)
- [Примеры использования](#примеры-использования)
  - [Текстовые запросы](#текстовые-запросы)
  - [Запросы с изображениями](#запросы-с-изображениями)
- [Работа с контекстом](#работа-с-контекстом)
- [Особенности реализации](#особенности-реализации)

## Назначение

Этот проект позволяет:

- Использовать модели Qwen AI через локальный API
- Сохранять контекст диалогов между запросами
- Управлять диалогами через API
- Выбирать различные модели Qwen для генерации ответов
- Отправлять изображения для анализа моделью

## Установка

1. Клонировать репозиторий
2. Установить зависимости:

```bash
npm install
```

## Запуск

```bash
npm start
```

Также доступен файл запуска:

```
start.bat
```

При первом запуске откроется окно браузера, в котором нужно авторизоваться на сайте Qwen AI. После успешной авторизации нажмите Enter в консоли для продолжения.

## API Reference

### Основные эндпоинты

| Эндпоинт | Метод | Описание |
|----------|-------|----------|
| `/api/chat` | POST | Отправка сообщения и получение ответа |
| `/api/models` | GET | Получение списка доступных моделей |
| `/api/status` | GET | Проверка статуса авторизации |
| `/api/chats` | POST | Создание нового диалога |
| `/api/chats` | GET | Получение списка всех диалогов |
| `/api/chats/:chatId` | GET | Получение истории диалога |
| `/api/chats/:chatId` | DELETE | Удаление диалога |
| `/api/chats/:chatId/rename` | PUT | Переименование диалога |
| `/api/chats/cleanup` | POST | Автоудаление диалогов по критериям |

### Форматы запросов

Прокси поддерживает два формата запросов к `/api/chat`:

#### 1. Упрощенный формат с параметром `message`

```json
{
  "message": "Текст сообщения",
  "model": "qwen-max-latest",
  "chatId": "идентификатор_чата"
}
```

#### 2. Формат, совместимый с официальным API Qwen, с параметром `messages`

```json
{
  "messages": [
    {"role": "user", "content": "Привет, как дела?"}
  ],
  "model": "qwen-max-latest",
  "chatId": "идентификатор_чата"
}
```

### Работа с историей диалога

**Важно понимать:** Прокси использует внутреннюю систему хранения истории диалогов на сервере.

1. При использовании формата `message` - сообщение просто добавляется в историю диалога.
2. При использовании формата `messages` - из массива извлекается только последнее сообщение пользователя и добавляется в историю.

При отправке запроса к официальному API Qwen **всегда** используется полная история диалога, связанная с указанным `chatId`. Это означает, что при использовании параметра `messages` вам достаточно включить только новое сообщение пользователя с ролью "user", а не всю историю диалога.

### Работа с изображениями

Прокси поддерживает отправку сообщений с изображениями в обоих форматах:

#### Формат `message` с изображением

```json
{
  "message": [
    {
      "type": "text",
      "text": "Опишите объекты на этом изображении"
    },
    {
      "type": "image",
      "image": "URL_ИЗОБРАЖЕНИЯ"
    }
  ],
  "model": "qwen3-235b-a22b",
  "chatId": "идентификатор_чата"
}
```

#### Формат `messages` с изображением

```json
{
  "messages": [
    {
      "role": "user", 
      "content": [
        {
          "type": "text",
          "text": "Опишите объекты на этом изображении"
        },
        {
          "type": "image",
          "image": "URL_ИЗОБРАЖЕНИЯ"
        }
      ]
    }
  ],
  "model": "qwen3-235b-a22b",
  "chatId": "идентификатор_чата"
}
```

### Получение URL изображения из интерфейса Qwen

Для отправки изображений через API прокси необходимо сначала получить URL изображения. Это можно сделать следующим образом:

1. Загрузите изображение в официальном веб-интерфейсе Qwen (<https://chat.qwen.ai/>)
2. Откройте инструменты разработчика в браузере (F12 или Ctrl+Shift+I)
3. Перейдите на вкладку "Network" (Сеть)
4. Найдите запрос к API Qwen, содержащий ваше изображение (обычно это запрос к `chat/completions`)
5. В теле запроса найдите URL изображения, который выглядит примерно так: `https://cdn.qwenlm.ai/user-id/file-id_filename.jpg?key=...`
6. Скопируйте этот URL для использования в вашем API-запросе

### Управление диалогами

#### Создание нового диалога

```
POST http://localhost:3264/api/chats
```

Тело запроса:

```json
{
  "name": "Название диалога"
}
```

Возвращает:

```json
{
  "chatId": "уникальный_идентификатор"
}
```

#### Получение списка всех диалогов

```
GET http://localhost:3264/api/chats
```

#### Получение истории диалога

```
GET http://localhost:3264/api/chats/:chatId
```

#### Удаление диалога

```
DELETE http://localhost:3264/api/chats/:chatId
```

#### Переименование диалога

```
PUT http://localhost:3264/api/chats/:chatId/rename
```

Тело запроса:

```json
{
  "name": "Новое название чата"
}
```

#### Автоматическое удаление диалогов

```
POST http://localhost:3264/api/chats/cleanup
```

Тело запроса (все параметры опциональны):

```json
{
  "olderThan": 604800000, // Удалить чаты старше указанного времени (в мс), например 7 дней
  "userMessageCountLessThan": 3, // Удалить чаты с менее чем 3 сообщениями от пользователя
  "messageCountLessThan": 5, // Удалить чаты с менее чем 5 сообщениями всего
  "maxChats": 50 // Оставить только 50 самых новых чатов
}
```

## Примеры использования

### Текстовые запросы

#### Пример простого текстового запроса

```bash
curl -X POST http://localhost:3264/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Что такое искусственный интеллект?",
    "model": "qwen-max-latest"
  }'
```

#### Пример запроса в формате официального API

```bash
curl -X POST http://localhost:3264/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      {"role": "user", "content": "Что такое искусственный интеллект?"}
    ],
    "model": "qwen-max-latest"
  }'
```

### Запросы с изображениями

#### Пример запроса с изображением

```bash
curl -X POST http://localhost:3264/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": [
      {
        "type": "text",
        "text": "Опишите объекты на этом изображении"
      },
      {
        "type": "image",
        "image": "https://cdn.qwenlm.ai/9e288181-c6b9-466d-9a68-afebbf31aa0a/b5e854e3-7286-4434-8ac7-aee0304d04d0_magway2-2.jpg?key=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyZXNvdXJjZV91c2VyX2lkIjoiOWUyODgxODEtYzZiOS00NjZkLTlhNjgtYWZlYmJmMzFhYTBhIiwicmVzb3VyY2VfaWQiOiJiNWU4NTRlMy03Mjg2LTQ0MzQtOGFjNy1hZWUwMzA0ZDA0ZDAiLCJyZXNvdXJjZV9jaGF0X2lkIjpudWxsfQ.3aWPB5QZ6D5whL5cr6owNEeQoiL5NzgekSla8lNwSJk"
      }
    ],
    "model": "qwen3-235b-a22b"
  }'
```

## Работа с контекстом

Система автоматически сохраняет историю диалога и отправляет ее в каждом запросе к API Qwen. Это позволяет моделям учитывать предыдущие сообщения при генерации ответов.

Для использования контекста в запросах:

1. Отправьте первое сообщение без указания `chatId`
2. Сохраните полученный `chatId` из ответа
3. Используйте этот `chatId` в последующих запросах

Пример последовательности запросов:

1. Первый запрос:

```json
{
  "message": "Привет, как тебя зовут?"
}
```

2. Ответ (сокращенно):

```json
{
  "chatId": "abcd-1234-5678",
  "choices": [...]
}
```

3. Второй запрос (с контекстом):

```json
{
  "message": "Сколько будет 2+2?",
  "chatId": "abcd-1234-5678"
}
```

## Особенности реализации

### Совместимость с API Qwen

Прокси стремится обеспечить максимальную совместимость с официальным API Qwen, поддерживая как упрощенный формат (`message`), так и стандартный формат (`messages`).

### Важные примечания

1. **Заголовок Content-Type:** Обязательно указывайте заголовок `Content-Type: application/json` в запросах, иначе сервер не сможет корректно обработать JSON-данные и выдаст ошибку "body пуст".

2. **Преобразование форматов:** Независимо от того, какой формат использует клиент (упрощенный `message` или стандартный `messages`), внутренне прокси всегда отправляет запросы к официальному API Qwen в формате `messages`, включая полную историю диалога.

3. **Работа с историей:** При использовании формата `messages` прокси извлекает только последнее сообщение пользователя для добавления в историю. Предыдущие сообщения уже хранятся на сервере и определяются по `chatId`.
